<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…‰èŠ’æˆ°ç·šï¼šç‰¹æŠ€è¦ºé†’</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        
        .speed-slot {
            width: 90px; height: 120px;
            background: rgba(30, 41, 59, 0.5);
            border: 2px dashed #475569;
            border-radius: 14px;
            display: flex; flex-direction: column; items: center; justify-content: center;
            transition: all 0.3s; position: relative;
        }
        .speed-slot.active { border-color: #eab308; background: rgba(234, 179, 8, 0.1); box-shadow: 0 0 20px rgba(234, 179, 8, 0.3); }
        .speed-slot.filled { border-style: solid; border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }

        .speed-badge {
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%);
            background: #eab308; color: black; font-weight: 900;
            padding: 2px 12px; border-radius: 999px; text-xs; z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }

        .card-mini {
            width: 100%; height: 100%; border-radius: 12px;
            display: flex; flex-direction: column; items: center; justify-content: center;
            font-size: 0.7rem; cursor: pointer; animation: popIn 0.2s ease-out;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .die { 
            width: 55px; height: 55px; background: white; color: black; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 10px; font-weight: bold; font-size: 1.6rem;
            box-shadow: 0 0 20px rgba(255,255,255,0.4); border: 2px solid #cbd5e1;
        }
        
        .rolling { animation: shake 0.1s infinite; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            50% { transform: translate(-1px, -1px) rotate(-5deg); }
            100% { transform: translate(1px, 1px) rotate(0deg); }
        }

        .damage-pop {
            position: absolute; animation: flyUp 1.2s ease-out forwards;
            font-weight: 900; pointer-events: none; z-index: 100; text-shadow: 0 2px 6px rgba(0,0,0,0.8);
        }
        @keyframes flyUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-120px) scale(1.2); opacity: 0; } }

        .skill-tag {
            font-size: 0.6rem; background: rgba(0,0,0,0.5); padding: 1px 4px; border-radius: 4px; color: #fbbf24; border: 1px solid #fbbf24; margin-top: 2px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen w-screen p-4">

    <div class="max-w-5xl w-full h-[95vh] bg-slate-900 rounded-3xl shadow-2xl border border-slate-700 flex flex-col relative overflow-hidden">
        
        <!-- é ‚éƒ¨ç‹€æ…‹ -->
        <div class="z-10 p-4 flex justify-between items-center bg-slate-950/80 backdrop-blur-md border-b border-slate-800">
            <div class="flex gap-4 items-center">
                <div class="text-yellow-500 font-bold tracking-tighter text-xl">å…‰èŠ’æˆ°ç·š</div>
                <div id="turn-display" class="bg-blue-900/30 text-blue-400 px-3 py-1 rounded text-xs border border-blue-800 font-mono">ROUND 01</div>
            </div>
            
            <div class="flex gap-10 text-sm">
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-red-500 font-bold uppercase tracking-widest">Health (HP)</span>
                    <span id="p-hp" class="font-mono text-red-400 text-2xl font-bold">100</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-purple-500 font-bold uppercase tracking-widest">Mind (SP)</span>
                    <span id="p-sp" class="font-mono text-purple-400 text-2xl font-bold">80</span>
                </div>
            </div>
        </div>

        <!-- æˆ°é¬¥å€åŸŸ -->
        <div class="flex-1 flex flex-col items-center justify-start p-8 relative overflow-hidden" id="battle-field">
            <!-- æ•µäºº -->
            <div id="enemy-zone" class="flex flex-col items-center mt-2 transition-all duration-500">
                <div class="relative group">
                    <div id="enemy-sprite" class="text-8xl mb-4 transition-all drop-shadow-[0_0_40px_rgba(239,68,68,0.4)]">ğŸ‘¾</div>
                    <div id="enemy-info" class="absolute -top-14 left-1/2 -translate-x-1/2 flex flex-col items-center gap-1">
                        <div id="enemy-intent" class="bg-red-950/95 text-red-100 text-[10px] px-3 py-1.5 rounded-lg border border-red-500 whitespace-nowrap shadow-2xl">æ„åœ–ï¼šè¼‰å…¥ä¸­...</div>
                        <div id="enemy-speed-tag" class="bg-yellow-600 text-white text-[10px] px-2 py-0.5 rounded font-bold shadow-md">SPD: 5</div>
                    </div>
                </div>
                <!-- æ•µäººè¡€æ¢ -->
                <div class="w-72 space-y-2">
                    <div class="h-2 bg-slate-800 rounded-full overflow-hidden border border-slate-700 shadow-inner">
                        <div id="e-hp-bar" class="h-full bg-gradient-to-r from-red-600 to-red-400 transition-all duration-500" style="width: 100%"></div>
                    </div>
                    <div class="h-1.5 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
                        <div id="e-sp-bar" class="h-full bg-gradient-to-r from-purple-600 to-purple-400 transition-all duration-500" style="width: 100%"></div>
                    </div>
                </div>
            </div>

            <!-- è¡Œå‹•è¦åŠƒå€ï¼ˆé€Ÿåº¦éª°æ§½ä½ï¼‰ -->
            <div id="planning-zone" class="flex gap-6 mt-12 items-center justify-center transition-all duration-500">
                <!-- ç”± JS ç”Ÿæˆ speed-slot -->
            </div>

            <!-- è¡çªå°æ±ºå€åŸŸ -->
            <div id="clash-zone" class="absolute inset-0 flex flex-col items-center justify-center opacity-0 pointer-events-none z-40 bg-slate-950/70 backdrop-blur-md transition-all duration-300">
                <div id="intercept-msg" class="text-4xl font-black italic text-yellow-400 tracking-tight mb-8 uppercase drop-shadow-2xl">æ””æˆªæˆåŠŸï¼</div>
                <div class="flex gap-24 items-center justify-center">
                    <div class="flex flex-col items-center gap-6">
                        <div id="p-dice-container" class="flex flex-col gap-4"></div>
                        <div class="text-sm text-blue-400 font-bold uppercase tracking-widest border-b-2 border-blue-500 pb-1">Player</div>
                    </div>
                    <div class="text-6xl animate-pulse">âš”ï¸</div>
                    <div class="flex flex-col items-center gap-6">
                        <div id="e-dice-container" class="flex flex-col gap-4"></div>
                        <div class="text-sm text-red-400 font-bold uppercase tracking-widest border-b-2 border-red-500 pb-1">Enemy</div>
                    </div>
                </div>
            </div>

            <div id="player-zone" class="absolute bottom-10"></div>
        </div>

        <!-- æ“ä½œå€ -->
        <div class="bg-slate-950/98 p-6 border-t border-slate-800 relative shadow-[0_-10px_50px_rgba(0,0,0,0.5)]">
            <div class="flex justify-between items-center mb-6 px-4">
                <div class="flex flex-col">
                    <div id="tutorial-msg" class="text-base text-slate-200 font-bold">éšæ®µï¼šè¦åŠƒè¡Œå‹•</div>
                    <div class="text-xs text-slate-500 italic">ç‰¹æ®Šèƒ½åŠ›å¡ç‰Œåœ¨å³ä¸‹è§’æ¨™è¨»æœ‰ [â˜…]</div>
                </div>
                <button id="start-clash-btn" disabled class="px-12 py-3 bg-slate-700 text-slate-400 font-black rounded-2xl transition-all uppercase tracking-widest text-sm disabled:opacity-50 disabled:cursor-not-allowed shadow-xl">
                    å•Ÿå‹•è¡çªæµç¨‹ (Clash)
                </button>
            </div>
            <!-- æ‰‹ç‰Œå€åŸŸ -->
            <div id="hand" class="flex justify-center gap-4 h-48 overflow-x-auto pb-4 px-10"></div>
        </div>
    </div>

    <script>
        // å¸¶æœ‰ç‰¹æ®Šèƒ½åŠ›çš„å¡ç‰Œåº«
        const CARD_POOL = [
            // --- ç‰¹æ®Šèƒ½åŠ›å¡ ---
            { name: 'å…‰èŠ’å‡çµ', type: 'UTILITY', dice: {count: 1, min: 10, max: 15}, color: 'from-amber-400 to-amber-700', icon: 'âœ¨', skill: 'RECOVERY', desc: 'çµç®—å¾Œå›å¾© 15 ç²¾ç¥', skillLabel: 'å›å…‰' },
            { name: 'å¿«é€Ÿé åˆ¤', type: 'UTILITY', dice: {count: 2, min: 4, max: 10}, color: 'from-blue-400 to-blue-600', icon: 'âš¡', skill: 'CYCLE', desc: 'ä½¿ç”¨å¾Œé¡å¤–æŠ½ä¸€å¼µç‰Œ', skillLabel: 'æ´—ç‰Œ' },
            { name: 'ä¾µè•æŒ‡ä»¤', type: 'MIND', dice: {count: 2, min: 8, max: 12}, color: 'from-indigo-600 to-indigo-900', icon: 'ğŸ‘¾', skill: 'WEAKEN', desc: 'å‘½ä¸­é™ä½ç›®æ¨™é€Ÿåº¦', skillLabel: 'å¼±åŒ–' },
            { name: 'çµ‚çµåŸ·è¡Œ', type: 'PHYSICAL', dice: {count: 1, min: 15, max: 20}, color: 'from-slate-800 to-black', icon: 'ğŸ’€', skill: 'FINISHER', desc: 'æ•µSP<50%æ™‚å‚·å®³+50%', skillLabel: 'çµ•æŠ€' },
            
            // --- åŸºç¤å¡ ---
            { name: 'é€£ç’°çªåˆº', type: 'PHYSICAL', dice: {count: 3, min: 4, max: 8}, color: 'from-red-500 to-red-800', icon: 'ğŸ—¡ï¸', desc: 'å¿«é€Ÿä¸‰æ¬¡æ‰“æ“Š' },
            { name: 'é‡éŒ˜ç ´é˜²', type: 'PHYSICAL', dice: {count: 1, min: 14, max: 24}, color: 'from-orange-600 to-orange-900', icon: 'ğŸ”¨', desc: 'é«˜å¨åŠ›å–®æ¬¡æ‰“æ“Š' },
            { name: 'éµå£é˜²ç¦¦', type: 'DEFEND', dice: {count: 2, min: 8, max: 14}, color: 'from-blue-600 to-blue-900', icon: 'ğŸ›¡ï¸', desc: 'å…©æ¬¡å …å›ºé˜²ç¦¦' },
            { name: 'èƒ½é‡è­·ç›¾', type: 'DEFEND', dice: {count: 1, min: 15, max: 25}, color: 'from-cyan-600 to-cyan-800', icon: 'ğŸ’ ', desc: 'å–®æ¬¡å¤§é¡é˜²è­·' },
            { name: 'æ€ç¶­å¹²æ¶‰', type: 'MIND', dice: {count: 2, min: 6, max: 12}, color: 'from-purple-500 to-purple-800', icon: 'ğŸ§ ', desc: 'æ”»æ“Šæ•µæ–¹ç²¾ç¥' },
            { name: 'æ•£å½ˆæƒå°„', type: 'PHYSICAL', dice: {count: 4, min: 2, max: 6}, color: 'from-rose-700 to-rose-900', icon: 'ğŸ”«', desc: 'å¤šæ®µè¼•é‡å£“åˆ¶' },
            { name: 'ç²¾å¯†è¨ˆç®—', type: 'DEFEND', dice: {count: 2, min: 10, max: 12}, color: 'from-slate-500 to-slate-700', icon: 'ğŸ”¢', desc: 'ç©©å®šçš„æ ¼æ“‹' }
        ];

        let state = {
            turn: 1,
            isGameOver: false,
            isClashing: false,
            player: { hp: 100, maxHp: 100, sp: 80, maxSp: 80 },
            enemy: { hp: 250, maxHp: 250, sp: 200, maxSp: 200, intent: 'PHYSICAL', dice: {count: 1, min: 10, max: 18}, speed: 4 },
            hand: [],
            speedSlots: [],
            selectedSlotIdx: 0,
            speedDieCount: 2
        };

        function init() {
            rollSpeedDice();
            drawCards(7);
            setEnemyIntent();
            updateUI();
        }

        function rollSpeedDice() {
            state.speedDieCount = 2 + Math.floor((state.turn - 1) / 3);
            state.speedSlots = Array.from({length: state.speedDieCount}, () => ({
                speed: Math.floor(Math.random() * 6) + 1,
                card: null
            }));
            state.selectedSlotIdx = 0;
            renderSpeedSlots();
        }

        function renderSpeedSlots() {
            const container = document.getElementById('planning-zone');
            container.innerHTML = '';
            state.speedSlots.forEach((slot, idx) => {
                const el = document.createElement('div');
                el.className = `speed-slot ${state.selectedSlotIdx === idx ? 'active' : ''} ${slot.card ? 'filled shadow-xl shadow-blue-900/40' : ''}`;
                
                let content = `<div class="speed-badge">${slot.speed}</div>`;
                if (slot.card) {
                    content += `
                        <div class="card-mini bg-gradient-to-br ${slot.card.color} text-white p-2" onclick="unplanCard(event, ${idx})">
                            <div class="text-2xl mb-1">${slot.card.icon}</div>
                            <div class="text-[9px] font-bold text-center leading-tight">${slot.card.name}</div>
                            ${slot.card.skillLabel ? `<div class="skill-tag">${slot.card.skillLabel}</div>` : ''}
                        </div>
                    `;
                } else {
                    content += `<div class="text-slate-600 text-[10px] font-bold uppercase tracking-widest">æ§½ä½ ${idx+1}</div>`;
                }
                
                el.innerHTML = content;
                el.onclick = () => { if(!state.isClashing) { state.selectedSlotIdx = idx; renderSpeedSlots(); } };
                container.appendChild(el);
            });
            checkReadyState();
        }

        function unplanCard(e, idx) {
            e.stopPropagation();
            if (state.isClashing) return;
            const removedCard = state.speedSlots[idx].card;
            if (removedCard) {
                state.hand.push(removedCard);
                state.speedSlots[idx].card = null;
                renderSpeedSlots();
                renderHand();
            }
        }

        function drawCards(count) {
            for(let i=0; i<count; i++) {
                const randomCard = CARD_POOL[Math.floor(Math.random() * CARD_POOL.length)];
                state.hand.push({...randomCard, instanceId: Math.random()});
            }
            renderHand();
        }

        function renderHand() {
            const handEl = document.getElementById('hand');
            handEl.innerHTML = '';
            state.hand.forEach(card => {
                const cardDiv = document.createElement('div');
                cardDiv.className = `min-w-[110px] h-[160px] bg-gradient-to-br ${card.color} rounded-2xl border border-white/20 p-3 flex flex-col items-center justify-between text-center cursor-pointer shadow-2xl hover:-translate-y-6 transition-all duration-300 relative group shrink-0`;
                cardDiv.onclick = () => planCard(card);
                cardDiv.innerHTML = `
                    <div class="text-3xl mt-1 group-hover:scale-125 transition-transform duration-500">${card.icon}</div>
                    <div class="flex flex-col gap-1">
                        <div class="text-[10px] font-black leading-tight uppercase tracking-tighter">${card.name}</div>
                        ${card.skillLabel ? `<div class="skill-tag self-center font-bold px-2 uppercase">[â˜… ${card.skillLabel}]</div>` : ''}
                        <div class="text-[7px] text-white/60 italic px-1">${card.desc}</div>
                    </div>
                    <div class="bg-black/50 w-full py-1.5 rounded-xl text-[10px] font-mono border border-white/10 font-bold">
                        ${card.dice.count}D [${card.dice.min}-${card.dice.max}]
                    </div>
                `;
                handEl.appendChild(cardDiv);
            });
        }

        function planCard(card) {
            if (state.isClashing || state.selectedSlotIdx === -1) return;
            
            if (state.speedSlots[state.selectedSlotIdx].card) {
                state.hand.push(state.speedSlots[state.selectedSlotIdx].card);
            }
            
            state.speedSlots[state.selectedSlotIdx].card = card;
            state.hand = state.hand.filter(c => c.instanceId !== card.instanceId);
            
            const nextEmpty = state.speedSlots.findIndex(s => !s.card);
            state.selectedSlotIdx = nextEmpty !== -1 ? nextEmpty : state.selectedSlotIdx;
            
            renderSpeedSlots();
            renderHand();
        }

        function checkReadyState() {
            const isAllFilled = state.speedSlots.every(s => s.card);
            const btn = document.getElementById('start-clash-btn');
            btn.disabled = !isAllFilled;
            btn.className = isAllFilled 
                ? "px-12 py-3 bg-blue-600 text-white font-black rounded-2xl transition-all uppercase tracking-widest text-sm shadow-[0_0_25px_rgba(59,130,246,0.6)] hover:bg-blue-500 hover:scale-105 active:scale-95"
                : "px-12 py-3 bg-slate-700 text-slate-400 font-black rounded-2xl transition-all uppercase tracking-widest text-sm disabled:opacity-50 disabled:cursor-not-allowed";
        }

        document.getElementById('start-clash-btn').onclick = async function() {
            state.isClashing = true;
            this.disabled = true;
            document.getElementById('tutorial-msg').innerText = "ç³»çµ±çµç®—ä¸­ï¼šå¡ç‰Œæ•ˆæœè§¸ç™¼...";
            
            document.getElementById('planning-zone').classList.add('opacity-0', 'scale-90', 'pointer-events-none');
            document.getElementById('enemy-zone').classList.add('translate-y-[-10px]');

            for (const slot of state.speedSlots) {
                if (state.isGameOver) break;
                
                // åŸ·è¡Œæ´—ç‰Œæ•ˆæœ (çµç®—å‰æŠ½ç‰Œ)
                if (slot.card.skill === 'CYCLE') {
                    drawCards(1);
                    showFloatingText('æ‰‹ç‰Œè£œçµ¦ï¼', '#3b82f6', 'player');
                }

                await executeClash(slot.card, slot.speed);
                
                // åŸ·è¡Œå›å…‰æ•ˆæœ (çµç®—å¾Œå›å¾©)
                if (slot.card.skill === 'RECOVERY') {
                    state.player.sp = Math.min(state.player.maxSp, state.player.sp + 15);
                    showFloatingText('+15 SP', '#fbbf24', 'player');
                    updateUI();
                }

                await new Promise(r => setTimeout(r, 1000));
            }

            if (!state.isGameOver) {
                state.isClashing = false;
                state.turn++;
                document.getElementById('planning-zone').classList.remove('opacity-0', 'scale-90', 'pointer-events-none');
                document.getElementById('enemy-zone').classList.remove('translate-y-[-10px]');
                rollSpeedDice();
                drawCards(state.speedDieCount);
                setEnemyIntent();
                updateUI();
                document.getElementById('tutorial-msg').innerText = "éšæ®µï¼šè¦åŠƒè¡Œå‹•";
            }
        };

        async function executeClash(card, playerSpeed) {
            const clashZone = document.getElementById('clash-zone');
            const pContainer = document.getElementById('p-dice-container');
            const eContainer = document.getElementById('e-dice-container');
            const interceptEl = document.getElementById('intercept-msg');
            
            pContainer.innerHTML = ''; eContainer.innerHTML = '';
            clashZone.classList.add('opacity-100', 'pointer-events-auto');

            const isIntercepted = playerSpeed > state.enemy.speed;
            interceptEl.innerText = isIntercepted ? "æ””æˆªæˆåŠŸï¼" : "è¢«å‹•æ¥æˆ°";
            interceptEl.className = `text-5xl font-black italic tracking-tighter mb-10 ${isIntercepted ? 'text-yellow-400 drop-shadow-[0_0_20px_rgba(234,179,8,0.8)]' : 'text-slate-500'}`;

            const pRolls = Array.from({length: card.dice.count}, () => Math.floor(Math.random() * (card.dice.max - card.dice.min + 1)) + card.dice.min);
            const eRolls = Array.from({length: state.enemy.dice.count}, () => Math.floor(Math.random() * (state.enemy.dice.max - state.enemy.dice.min + 1)) + state.enemy.dice.min);

            const pDiceEls = pRolls.map(() => {
                const d = document.createElement('div'); d.className = 'die rolling'; d.innerText = '?';
                pContainer.appendChild(d); return d;
            });
            const eDiceEls = eRolls.map(() => {
                const d = document.createElement('div'); d.className = 'die rolling'; d.innerText = '?';
                eContainer.appendChild(d); return d;
            });

            await new Promise(r => setTimeout(r, 600));
            pDiceEls.forEach((el, i) => { el.classList.remove('rolling'); el.innerText = pRolls[i]; el.classList.add('bg-blue-50', 'border-blue-400'); });
            eDiceEls.forEach((el, i) => { el.classList.remove('rolling'); el.innerText = eRolls[i]; el.classList.add('bg-red-50', 'border-red-400'); });
            await new Promise(r => setTimeout(r, 400));

            const rounds = Math.max(pRolls.length, eRolls.length);
            for (let i = 0; i < rounds; i++) {
                const pv = pRolls[i] || 0;
                const ev = eRolls[i] || 0;
                
                if (pv > ev) {
                    let damage = pv - ev;
                    // çµ•æŠ€æ•ˆæœï¼šæ•µ SP ä½æ–¼ 50% å¢å‚·
                    if (card.skill === 'FINISHER' && (state.enemy.sp / state.enemy.maxSp < 0.5)) {
                        damage *= 1.5;
                        showFloatingText('çµ•æŠ€è§¸ç™¼ï¼', '#ef4444', 'enemy');
                    }
                    
                    applyDamage('enemy', damage, card.type);
                    
                    // å¼±åŒ–æ•ˆæœï¼šé™ä½æ•µé€Ÿ
                    if (card.skill === 'WEAKEN') {
                        state.enemy.speed = Math.max(1, state.enemy.speed - 1);
                        showFloatingText('é€Ÿåº¦é™ä½ â†“', '#a855f7', 'enemy');
                    }
                    
                    if (pDiceEls[i]) pDiceEls[i].classList.add('scale-125', 'shadow-blue-500/80');
                } else if (ev > pv) {
                    applyDamage('player', ev - pv, state.enemy.intent);
                    if (eDiceEls[i]) eDiceEls[i].classList.add('scale-125', 'shadow-red-500/80');
                }
                
                await new Promise(r => setTimeout(r, 500));
                if(state.isGameOver) break;
            }

            await new Promise(r => setTimeout(r, 800));
            clashZone.classList.remove('opacity-100', 'pointer-events-auto');
        }

        function showFloatingText(text, color, target) {
            const rect = document.getElementById(target === 'player' ? 'player-zone' : 'enemy-zone').getBoundingClientRect();
            const pop = document.createElement('div');
            pop.className = 'damage-pop text-xl font-bold italic';
            pop.style.left = (rect.left + rect.width/2 + (Math.random()*40-20)) + 'px';
            pop.style.top = (rect.top - 40) + 'px';
            pop.style.color = color;
            pop.innerText = text;
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 1200);
        }

        function applyDamage(target, amount, type) {
            const isPlayer = target === 'player';
            const rect = document.getElementById(isPlayer ? 'player-zone' : 'enemy-zone').getBoundingClientRect();
            const pop = document.createElement('div');
            pop.className = 'damage-pop text-4xl font-black';
            pop.style.left = (rect.left + rect.width/2 + (Math.random()*60-30)) + 'px';
            pop.style.top = (rect.top + (Math.random()*30)) + 'px';
            pop.style.color = type === 'MIND' ? '#c084fc' : '#f87171';
            pop.innerText = `-${Math.round(amount)}`;
            document.body.appendChild(pop);
            setTimeout(() => pop.remove(), 1200);

            if (isPlayer) {
                if (type === 'MIND') state.player.sp -= amount;
                else state.player.hp -= amount;
                shakeElement('battle-field', 12);
            } else {
                if (type === 'MIND') state.enemy.sp -= amount;
                else state.enemy.hp -= amount;
                shakeElement('enemy-zone', 18);
            }
            updateUI();
            checkGameOver();
        }

        function setEnemyIntent() {
            const intents = [
                { type: 'PHYSICAL', dice: {count: 1, min: 14, max: 26}, text: 'ç‹‚æš´æ’•å’¬ [14-26]', speed: 3, sprite: 'ğŸ‘º' },
                { type: 'PHYSICAL', dice: {count: 2, min: 10, max: 16}, text: 'äºŒé€£æš—å½±æ“Š 2d[10-16]', speed: 5, sprite: 'ğŸ¦‡' },
                { type: 'MIND', dice: {count: 1, min: 18, max: 30}, text: 'å™©å¤¢æåš‡ [18-30]', speed: 2, sprite: 'ğŸ‘ï¸' },
                { type: 'PHYSICAL', dice: {count: 3, min: 6, max: 12}, text: 'è§¸æ‰‹é­æ‰“ 3d[6-12]', speed: 4, sprite: 'ğŸ™' }
            ];
            const pick = intents[Math.floor(Math.random() * intents.length)];
            state.enemy.intent = pick.type;
            state.enemy.dice = pick.dice;
            state.enemy.speed = pick.speed;
            
            document.getElementById('enemy-sprite').innerText = pick.sprite;
            document.getElementById('enemy-intent').innerText = `æ„åœ–ï¼š${pick.text}`;
            document.getElementById('enemy-speed-tag').innerText = `SPD: ${pick.speed}`;
        }

        function shakeElement(id, intensity) {
            const el = document.getElementById(id);
            el.style.transform = `translateX(${intensity}px)`;
            setTimeout(() => el.style.transform = `translateX(-${intensity}px)`, 50);
            setTimeout(() => el.style.transform = `translateX(0px)`, 100);
        }

        function updateUI() {
            document.getElementById('p-hp').innerText = Math.max(0, Math.ceil(state.player.hp));
            document.getElementById('p-sp').innerText = Math.max(0, Math.ceil(state.player.sp));
            document.getElementById('e-hp-bar').style.width = (state.enemy.hp / state.enemy.maxHp * 100) + '%';
            document.getElementById('e-sp-bar').style.width = (state.enemy.sp / state.enemy.maxSp * 100) + '%';
            document.getElementById('turn-display').innerText = `ROUND ${state.turn.toString().padStart(2, '0')}`;
        }

        function checkGameOver() {
            if (state.enemy.hp <= 0 || state.enemy.sp <= 0) { 
                state.isGameOver = true; 
                alert("ç›®æ¨™å¾¹åº•æ²‰é»˜... æˆ°é¬¥å‹åˆ©ï¼"); 
                location.reload(); 
            }
            else if (state.player.hp <= 0 || state.player.sp <= 0) { 
                state.isGameOver = true; 
                alert("æ„è­˜é–‹å§‹æ¶ˆæ•£... ä½ æˆ°æ•—äº†ã€‚"); 
                location.reload(); 
            }
        }

        window.onload = init;
    </script>
</body>
</html>
