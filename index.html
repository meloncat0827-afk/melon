<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deeeepminer.io</title>
    <!-- è¼‰å…¥ Tailwind CSS for modern structure and utility -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨è‡ªè¨‚ CSS å‰µå»ºåƒç´ é¢¨æ ¼å’ŒéŠæˆ²æ°›åœ */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        
        :root {
            --pixel-font: 'VT323', monospace;
            --primary-color: #4CAF50; /* ç¶ è‰²ï¼Œä»£è¡¨æŒ–ç¤¦/ç”Ÿå‘½ */
            --secondary-color: #FFC107; /* é»ƒè‰²ï¼Œä»£è¡¨èƒ½é‡/é‡‘éŒ¢ */
            --dark-bg: #1A1A1A;
            --light-text: #FFFFFF;
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--dark-bg);
            color: var(--light-text);
            overscroll-behavior: none; /* é˜²æ­¢ç§»å‹•ç«¯ä¸‹æ‹‰åˆ·æ–° */
        }

        /* åƒç´ åŒ–æŒ‰éˆ•æ¨£å¼ */
        .pixel-btn {
            background-color: var(--primary-color);
            color: var(--dark-bg);
            border: 4px solid #101010;
            padding: 8px 16px;
            text-shadow: 1px 1px #000;
            box-shadow: 4px 4px #101010;
            transition: all 0.1s;
            line-height: 1;
            font-size: 1.5rem;
            cursor: pointer;
            -webkit-appearance: none; /* For mobile */
            -moz-appearance: none;
            appearance: none;
            border-radius: 0; /* åƒç´ é¢¨ä¸éœ€è¦åœ“è§’ */
        }

        .pixel-btn:hover {
            background-color: #66BB6A;
            box-shadow: 2px 2px #101010;
            transform: translate(2px, 2px);
        }

        .pixel-btn:active {
            box-shadow: none;
            transform: translate(4px, 4px);
        }

        /* HUD æ¨£å¼ */
        .hud-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid var(--primary-color);
            padding: 8px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            font-size: 1.25rem;
        }

        /* èƒ½é‡æ¢æ¨£å¼ */
        .energy-bar-container {
            width: 100%;
            height: 24px;
            background: #333;
            border: 2px solid #000;
            margin-top: 4px;
        }

        .energy-bar {
            height: 100%;
            background-color: var(--secondary-color);
            transition: width 0.3s;
        }

        /* ç¬¬äºŒæ®µä»‹é¢ (Meta Modal) */
        #meta-modal {
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .meta-container {
            width: 95%;
            max-width: 900px; /* ç¨å¾®æ”¾å¤§å®¹å™¨ä»¥å®¹ç´æ›´å¤šå…§å®¹ */
            height: 90%;
            max-height: 650px;
            background: #282C34;
            border: 5px solid var(--primary-color);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
            padding: 16px;
            overflow-y: auto;
        }

        .meta-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: 2px solid transparent;
            font-size: 1.5rem;
            white-space: nowrap; /* é˜²æ­¢ Tab æ›è¡Œ */
        }

        .meta-tab.active {
            border: 2px solid var(--secondary-color);
            background: rgba(255, 193, 7, 0.2);
            color: var(--secondary-color);
        }

        /* é …ç›®å¡ç‰‡æ¨£å¼ */
        .item-card {
            background: #3c414a;
            border: 2px solid #555;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .item-card .pixel-btn {
            font-size: 1.2rem;
        }
        
        /* ç¨€æœ‰ç¤¦çŸ³åˆ—è¡¨å°ˆç”¨æ¨£å¼ */
        .rare-ore-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .rare-ore-card {
            background: #3c414a;
            border: 2px solid #555;
            padding: 10px;
            text-align: center;
        }

        /* ============================== */
        /* === ç¨€æœ‰ç¤¦çŸ³å‹•ç•« CSS æ•ˆæœ === */
        /* ============================== */

        /* Animation Keyframes */
        @keyframes epic-flash {
            0% { opacity: 0; background-color: rgba(255, 255, 0, 0); }
            50% { opacity: 1; background-color: rgba(255, 255, 0, 0.4); }
            100% { opacity: 0; background-color: rgba(255, 255, 0, 0); }
        }

        @keyframes legendary-burst {
            0% { opacity: 0; background-color: rgba(255, 0, 255, 0); }
            25% { opacity: 1; background-color: rgba(255, 0, 255, 0.6); transform: scale(1.05); }
            50% { opacity: 1; background-color: rgba(255, 255, 255, 0.8); }
            75% { opacity: 1; background-color: rgba(255, 0, 255, 0.6); }
            100% { opacity: 0; background-color: rgba(255, 0, 255, 0); transform: scale(1); }
        }

        @keyframes cosmic-explosion {
            0%, 100% { opacity: 0; background-color: rgba(0, 0, 0, 0); }
            10% { opacity: 1; background-color: rgba(255, 255, 255, 1); border-color: #00FFFF; transform: scale(1.1); box-shadow: 0 0 50px #00FFFF; }
            30% { opacity: 1; background-color: rgba(255, 0, 255, 0.8); border-color: #FF00FF; transform: scale(1.05); box-shadow: 0 0 40px #FF00FF; }
            50% { opacity: 1; background-color: rgba(255, 255, 255, 1); border-color: #FFFF00; transform: scale(1.1); box-shadow: 0 0 50px #FFFF00; }
            70% { opacity: 1; background-color: rgba(0, 255, 255, 0.8); border-color: #00FFFF; transform: scale(1.05); box-shadow: 0 0 40px #00FFFF; }
            90% { opacity: 1; background-color: rgba(255, 255, 255, 1); }
        }

        /* å…¨å±é–ƒå…‰ç–Šå±¤ */
        #flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99; /* ä½æ–¼ Modalï¼Œé«˜æ–¼éŠæˆ²ç•«é¢ */
            pointer-events: none;
            opacity: 0;
        }

        /* å¥—ç”¨å‹•ç•«é¡ */
        .flash-epic {
            animation: epic-flash 0.5s ease-out 1;
        }

        .flash-legendary {
            animation: legendary-burst 1s ease-in-out 1;
        }

        .flash-cosmic {
            animation: cosmic-explosion 1.5s linear 1;
        }

        /* Canvas å®¹å™¨é‚Šæ¡†æ•ˆæœ */
        #canvas-container {
            transition: all 0.15s ease-out; /* è®“é‚Šæ¡†è®ŠåŒ–æ›´å¹³æ»‘ */
        }

        .canvas-legendary-border {
            border-color: #FF00FF !important;
            box-shadow: 0 0 20px #FF00FF;
            transform: scale(1.005);
        }

        .canvas-cosmic-border {
            border-color: #00FFFF !important;
            box-shadow: 0 0 30px #00FFFF, 0 0 10px #FFFF00;
            transform: scale(1.01);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 select-none">

    <!-- å…¨å±€è®Šæ•¸åˆå§‹åŒ– (Firebase ä½”ä½ç¬¦) -->
    <script>
        // é€™æ˜¯ Firestore å¿…è¦çš„å…¨å±€è®Šæ•¸ä½”ä½ç¬¦ï¼Œç”¨æ–¼æœªä¾†å¯¦ä½œè³‡æ–™æŒä¹…åŒ–
        const __app_id = 'mining-rpg-deeeep-style';
        const __firebase_config = '{}'; 
    </script>
    
    <!-- ç¬¬ä¸€æ®µä»‹é¢ï¼šæŒ–ç¤¦æ¨¡å¼ (Action View) -->
    <div id="mining-view" class="w-full h-full flex flex-col items-center">
        
        <!-- HUD é ‚éƒ¨è³‡è¨Šæ¬„ -->
        <div class="hud-panel w-full max-w-4xl mb-4 text-center">
            <div class="flex justify-between items-center text-xl mb-1">
                <span>æ·±åº¦: <span id="depth-display">0 M</span></span>
                <span class="text-secondary-color">èƒ½é‡: <span id="energy-value">100</span>/<span id="max-energy-value">100</span></span>
                <button id="meta-btn" class="pixel-btn px-4 py-1 text-sm bg-blue-600 hover:bg-blue-700">è£å‚™/å‡ç´š (Meta)</button>
            </div>
            <div class="energy-bar-container mb-2">
                <div id="energy-bar" class="energy-bar" style="width: 100%;"></div>
            </div>
            
            <!-- è³‡æº/å®¹é‡é¡¯ç¤º -->
            <div class="flex justify-around text-lg">
                <span>çŸ³é ­: <span id="res-stone">0</span> / <span id="max-res-stone">500</span></span>
                <span>ç¤¦ç‰©: <span id="res-ore">0</span> / <span id="max-res-ore">500</span></span>
                <span>é‡‘éŒ¢: <span id="res-money">0</span></span>
            </div>
        </div>

        <!-- éŠæˆ² Canvas å€åŸŸå®¹å™¨ (æ–°å¢ ID ä»¥ä¾¿æ§åˆ¶é‚Šæ¡†å‹•ç•«) -->
        <div id="canvas-container" class="w-full max-w-4xl aspect-[16/9] bg-gray-800 border-4 border-gray-900 shadow-2xl relative overflow-hidden">
            <canvas id="game-canvas" class="w-full h-full"></canvas>
            <!-- æŒ–ç¤¦æŒ‰éˆ•/è¨Šæ¯æ¡† -->
            <div id="action-area" class="absolute inset-0 flex flex-col items-center justify-center p-4">
                <div id="action-message" class="text-2xl text-red-400 mb-4 bg-black/70 p-2 hidden">èƒ½é‡è€—ç›¡ï¼è«‹ä¼‘æ¯æˆ–è£œå……ï¼</div>
                <div id="storage-message" class="text-2xl text-red-400 mb-4 bg-black/70 p-2 hidden">èƒŒåŒ…å·²æ»¿ï¼è«‹å‡ºå”®æˆ–å‡ç´šå®¹é‡ï¼</div>
                <button id="mine-btn" class="pixel-btn text-3xl p-6 transition-all duration-100 ease-in-out">â›ï¸ é»æ“ŠæŒ–ç¤¦ â›ï¸</button>
            </div>
        </div>
        
        <!-- å…¨å±é–ƒå…‰ç–Šå±¤ (ç”¨æ–¼ç¨€æœ‰ç¤¦çŸ³å‹•ç•«) -->
        <div id="flash-overlay" class="absolute inset-0"></div>
    </div>
    
    <!-- ç¬¬äºŒæ®µä»‹é¢ï¼šå…ƒæ•¸æ“šæ¨¡å¼ (Meta Modal) -->
    <div id="meta-modal" class="fixed inset-0 flex items-center justify-center hidden">
        <div class="meta-container">
            <h2 class="text-3xl border-b-4 border-primary-color pb-2 mb-4">å…ƒæ•¸æ“šä¸­å¿ƒ</h2>

            <!-- æ¨™ç±¤å°èˆª -->
            <div class="flex mb-4 border-b border-gray-500 overflow-x-auto">
                <div class="meta-tab active" data-tab="upgrades">âš’ï¸ å‡ç´š (Upgrades)</div>
                <div class="meta-tab" data-tab="crafting">âš™ï¸ è£½é€  (Pickaxes)</div>
                <div class="meta-tab" data-tab="consumables">ğŸ›’ è£œçµ¦ (Shop)</div>
                <div class="meta-tab" data-tab="rare_ores">ğŸ”® å¥‡çç¤¦çŸ³ (Rare Ores)</div>
                <div class="meta-tab" data-tab="stats">ğŸ“ˆ ç‹€æ…‹ (Stats)</div>
            </div>

            <!-- æ¨™ç±¤å…§å®¹ -->
            <div id="tab-content">
                <!-- å‡ç´š Tab (Upgrades) -->
                <div id="upgrades" class="meta-content">
                    <h3 class="text-2xl mb-4">æ ¸å¿ƒå‡ç´š (èƒŒåŒ…æ“´å®¹ã€èƒ½é‡æ“´å®¹ã€æ•ˆç‡)</h3>

                    <div id="upgrade-list">
                        <!-- å‡ç´šé …ç›®å°‡ç”± JS å¡«å…… -->
                    </div>
                </div>

                <!-- è£½é€  Tab (Crafting - Pickaxes) -->
                <div id="crafting" class="meta-content hidden">
                    <h3 class="text-2xl mb-4">é¬å­è£½é€ /å‡ç´š</h3>
                    <div id="crafting-list">
                        <!-- è£½é€ é …ç›®å°‡ç”± JS å¡«å…… -->
                    </div>
                </div>
                
                <!-- è£œçµ¦ Tab (Consumables - Shop) -->
                <div id="consumables" class="meta-content hidden">
                    <h3 class="text-2xl mb-4">èƒ½é‡è£œçµ¦ç«™ (ä½¿ç”¨é‡‘éŒ¢è³¼è²·)</h3>
                    <div id="consumables-list">
                        <!-- æ¶ˆè€—å“é …ç›®å°‡ç”± JS å¡«å…… -->
                    </div>
                </div>
                
                <!-- å¥‡çç¤¦çŸ³ Tab (Rare Ores) -->
                <div id="rare_ores" class="meta-content hidden">
                    <h3 class="text-2xl mb-4">å·²ç™¼ç¾çš„ç¨€æœ‰ç¤¦ç‰© (å…± 1000 ç¨®)</h3>
                    <div id="rare-ore-list" class="rare-ore-grid">
                        <!-- ç¨€æœ‰ç¤¦çŸ³åˆ—è¡¨å°‡ç”± JS å¡«å…… -->
                    </div>
                </div>

                <!-- ç‹€æ…‹ Tab (Stats) -->
                <div id="stats" class="meta-content hidden">
                    <h3 class="text-2xl mb-4">ç•¶å‰ç‹€æ…‹</h3>
                    <p>ç•¶å‰é¬å­ç­‰ç´š: <span id="stat-pickaxe">1</span></p>
                    <p>æ¯æ¬¡æŒ–ç¤¦æ¶ˆè€—èƒ½é‡: <span id="stat-energy-cost">5</span></p>
                    <p>æ¯æ¬¡æŒ–ç¤¦åŸºç¤æ”¶ç›Š: <span id="stat-base-yield">1</span></p>
                    <p>æœ€å¤§èƒ½é‡å€¼: <span id="stat-max-energy">100</span></p>
                    <p>èƒŒåŒ…æœ€å¤§å®¹é‡: <span id="stat-max-resources">500</span></p>
                    <p class="mt-4 text-secondary-color">æç¤ºï¼šæ¯ 10 ç§’æœƒè‡ªå‹•æ¢å¾© 1 é»èƒ½é‡ã€‚</p>
                </div>
            </div>

            <!-- é—œé–‰æŒ‰éˆ• -->
            <button id="close-meta-btn" class="pixel-btn absolute top-4 right-4 bg-red-600 hover:bg-red-700">X é—œé–‰</button>
        </div>
    </div>

    <!-- éŠæˆ²é‚è¼¯èˆ‡äº¤äº’ -->
    <script>
        // --- ç¤¦çŸ³æ•¸æ“šç”Ÿæˆ (ä¿æŒä¸è®Š) ---
        const RARE_ORE_COUNT = 1000;
        const MIN_RARITY_MULTIPLIER = 1000; 
        const MAX_RARITY_MULTIPLIER = 1500000000;

        function generateRareOresData() {
            const rareOres = [];
            const logRange = Math.log(MAX_RARITY_MULTIPLIER) - Math.log(MIN_RARITY_MULTIPLIER);
            const step = logRange / (RARE_ORE_COUNT - 1);

            for (let i = 0; i < RARE_ORE_COUNT; i++) {
                const rarityLog = Math.log(MIN_RARITY_MULTIPLIER) + i * step;
                const rarityMultiplier = Math.round(Math.exp(rarityLog));
                
                let nameSuffix;
                if (rarityMultiplier >= 1000000000) nameSuffix = 'å®‡å®™ç´š';
                else if (rarityMultiplier >= 100000000) nameSuffix = 'æ˜Ÿç³»ç´š';
                else if (rarityMultiplier >= 1000000) nameSuffix = 'å‚³èªªç´š';
                else if (rarityMultiplier >= 10000) nameSuffix = 'å²è©©ç´š';
                else nameSuffix = 'ç¨€æœ‰ç´š';

                rareOres.push({
                    id: `rareOre_${i + 1}`,
                    name: `${nameSuffix} #${i + 1}`,
                    rarity: rarityMultiplier,
                });
            }
            return rareOres;
        }

        const rareOresData = generateRareOresData();


        // --- éŠæˆ²ç‹€æ…‹ç®¡ç† (Game State) ---
        let gameState = {
            energy: 100,
            maxEnergy: 100,
            depth: 0,
            money: 0,
            resources: {
                stone: 0,
                ore: 0, // Standard Ore
            },
            maxResources: 500, // æ–°å¢: æœ€å¤§è³‡æºå®¹é‡
            rareOres: {},
            pickaxeLevel: 1,
            pickaxeCost: 5, // Energy cost per mine
            pickaxeYield: 1, // Base stone yield per mine
            
            // å‡ç´šè¿½è¹¤
            efficiency: 1, 
            maxEnergyUpgrade: 1, 
            yield: 1, 
            bagUpgradeLevel: 1, // æ–°å¢: èƒŒåŒ…æ“´å®¹ç­‰ç´š
        };

        // --- å‡ç´š/è£½é€ /æ¶ˆè€—å“ æ•¸æ“š ---

        // æ ¸å¿ƒå‡ç´šæ•¸æ“š (åŒ…å«èƒŒåŒ…æ“´å®¹)
        const upgradesData = [
            { id: 'maxEnergyUpgrade', name: 'ğŸ”‹ æœ€å¤§èƒ½é‡æ“´å®¹', costResource: 'money', baseCost: 100, effect: 'maxEnergy', value: 20, desc: 'æ°¸ä¹…å¢åŠ æœ€å¤§èƒ½é‡å€¼ 20 é»ã€‚', maxLevel: 100 },
            { id: 'efficiency', name: 'âš¡ æŒ–ç¤¦æ•ˆç‡æå‡', costResource: 'ore', baseCost: 10, effect: 'pickaxeCost', value: -1, desc: 'æ¯æ¬¡æŒ–ç¤¦æ¶ˆè€—èƒ½é‡æ¸›å°‘ 1 é»ã€‚', maxLevel: 50 },
            { id: 'yield', name: 'ğŸ’ åŸºç¤æ”¶ç›Šå¼·åŒ–', costResource: 'stone', baseCost: 50, effect: 'pickaxeYield', value: 1, desc: 'æ¯æ¬¡æŒ–ç¤¦åŸºç¤æ”¶ç›Šå¢åŠ  1 é»ã€‚', maxLevel: 100 },
            // æ–°å¢èƒŒåŒ…å‡ç´š (å…± 5 å€‹ç­‰ç´šï¼Œå¾ Level 1 å‡ç´šåˆ° Level 6)
            { id: 'bagUpgradeLevel', name: 'ğŸ’ èƒŒåŒ…ç©ºé–“æ“´å±•', costResource: 'money', baseCost: 500, effect: 'maxResources', value: 500, desc: 'å°‡è³‡æºå„²å­˜ä¸Šé™å¢åŠ  500 é»ã€‚', maxLevel: 60 }, 
        ];
        
        // è£å‚™è£½é€ æ•¸æ“š (æ“´å±•è‡³ 8 ç´šé¬)
        const craftingData = [
            { id: 'pickaxe2', name: 'éµé¬', required: { stone: 50, ore: 20 }, effect: { level: 2, cost: 3, yield: 2 }, desc: 'Lv. 2ï¼šæå‡æ•ˆç‡èˆ‡æ”¶ç›Šã€‚' },
            { id: 'pickaxe3', name: 'é‘½çŸ³é¬', required: { stone: 200, ore: 100 }, effect: { level: 3, cost: 1, yield: 5 }, desc: 'Lv. 3ï¼šé”åˆ°é ‚ç´šæ•ˆç‡ã€‚' },
            { id: 'pickaxe4', name: 'éˆ¦åˆé‡‘é¬', required: { stone: 500, ore: 300, money: 1000 }, effect: { level: 4, cost: 1, yield: 10 }, desc: 'Lv. 4ï¼šå¢åŠ åŸºç¤æ”¶ç›Šã€‚' },
            { id: 'pickaxe5', name: 'èƒ½é‡çµæ™¶é¬', required: { stone: 1000, ore: 500, money: 5000 }, effect: { level: 5, cost: 0, yield: 15 }, desc: 'Lv. 5ï¼šä¸å†æ¶ˆè€—èƒ½é‡ï¼' },
            { id: 'pickaxe6', name: 'æ˜Ÿæ˜Ÿæ¡é›†é¬', required: { stone: 2000, ore: 1000, money: 15000 }, effect: { level: 6, cost: 0, yield: 25 }, desc: 'Lv. 6ï¼šæ¥µå¤§åœ°å¢åŠ æ”¶ç›Šã€‚' },
            { id: 'pickaxe7', name: 'å®‡å®™åˆ†è§£è€…', required: { stone: 5000, ore: 3000, money: 50000 }, effect: { level: 7, cost: 0, yield: 50 }, desc: 'Lv. 7ï¼šé–‹å§‹æŒ–æ˜æ›´é«˜éšè³‡æºã€‚' },
            { id: 'pickaxe8', name: 'å‰µä¸–ç¥ä¹‹æ‰‹', required: { stone: 10000, ore: 5000, money: 100000 }, effect: { level: 8, cost: 0, yield: 100 }, desc: 'Lv. 8ï¼šæœ€çµ‚ç´šåˆ¥ï¼ŒæŒ–æ˜æ•ˆç‡é”åˆ°æ¥µé™ã€‚' },
        ];
        
        // æ¶ˆè€—å“ (é£Ÿç‰©) æ•¸æ“š
        const consumablesData = [
            { id: 'food_small', name: 'â˜• å’–å•¡', cost: 100, energy: 50, desc: 'ç«‹å³æ¢å¾© 50 é»èƒ½é‡ã€‚' },
            { id: 'food_medium', name: 'ğŸ” æ¼¢å ¡', cost: 500, energy: 300, desc: 'ç«‹å³æ¢å¾© 200 é»èƒ½é‡ã€‚' },
            { id: 'food_large', name: 'ğŸš€ èƒ½é‡é£²', cost: 2000, energy: 1500, desc: 'ç¬é–“å……æ»¿èƒ½é‡ï¼Œç”šè‡³è¶…è¶Šä¸Šé™ã€‚' },
        ];

        // --- DOM å…ƒç´ ç²å– ---
        const $metaBtn = document.getElementById('meta-btn');
        const $metaModal = document.getElementById('meta-modal');
        const $closeMetaBtn = document.getElementById('close-meta-btn');
        const $mineBtn = document.getElementById('mine-btn');
        const $actionMessage = document.getElementById('action-message');
        const $storageMessage = document.getElementById('storage-message'); // æ–°å¢
        const $tabContents = document.querySelectorAll('.meta-content');
        const $tabs = document.querySelectorAll('.meta-tab');
        const $upgradeList = document.getElementById('upgrade-list');
        const $craftingList = document.getElementById('crafting-list');
        const $consumablesList = document.getElementById('consumables-list'); // æ–°å¢
        const $rareOreList = document.getElementById('rare-ore-list');
        const $flashOverlay = document.getElementById('flash-overlay');
        const $canvasContainer = document.getElementById('canvas-container');

        // --- ä»‹é¢æ›´æ–°å‡½æ•¸ (Stage 1 HUD) ---
        function updateHUD() {
            const currentStone = gameState.resources.stone;
            const currentOre = gameState.resources.ore;
            const maxRes = gameState.maxResources;

            document.getElementById('depth-display').textContent = `${gameState.depth} M`;
            document.getElementById('energy-value').textContent = gameState.energy.toLocaleString();
            document.getElementById('max-energy-value').textContent = gameState.maxEnergy.toLocaleString();
            document.getElementById('energy-bar').style.width = `${(gameState.energy / gameState.maxEnergy) * 100}%`;
            document.getElementById('res-stone').textContent = currentStone.toLocaleString();
            document.getElementById('res-ore').textContent = currentOre.toLocaleString();
            document.getElementById('res-money').textContent = gameState.money.toLocaleString();
            document.getElementById('max-res-stone').textContent = maxRes.toLocaleString(); // æ›´æ–°å®¹é‡é¡¯ç¤º
            document.getElementById('max-res-ore').textContent = maxRes.toLocaleString();

            const isEnergyLow = gameState.energy <= 0;
            const isStorageFull = currentStone >= maxRes || currentOre >= maxRes;
            
            // æª¢æŸ¥æŒ–ç¤¦æ¢ä»¶
            if (isEnergyLow || isStorageFull) {
                $mineBtn.disabled = true;
                $mineBtn.textContent = isEnergyLow ? 'ç­‹ç–²åŠ›ç›¡...' : 'èƒŒåŒ…å·²æ»¿ï¼';
                $mineBtn.classList.add('bg-gray-500', 'hover:bg-gray-500');
                $mineBtn.classList.remove('bg-primary-color', 'hover:bg-primary-color');
            } else {
                $mineBtn.disabled = false;
                $mineBtn.textContent = `â›ï¸ é»æ“ŠæŒ–ç¤¦ (æ¶ˆè€— ${gameState.pickaxeCost} èƒ½é‡) â›ï¸`;
                $mineBtn.classList.remove('bg-gray-500', 'hover:bg-gray-500');
                $mineBtn.classList.add('bg-primary-color', 'hover:bg-primary-color');
            }
            
            // é¡¯ç¤ºè­¦å‘Šè¨Šæ¯
            $actionMessage.classList.toggle('hidden', !isEnergyLow);
            $storageMessage.classList.toggle('hidden', !isStorageFull || isEnergyLow);
        }
        
        // ç¨€æœ‰ç¤¦çŸ³å‹•ç•«æ•ˆæœ (ä¿æŒä¸è®Š)
        function triggerRareAnimation(rarity) {
            let flashClass = '';
            let duration = 0;

            $flashOverlay.className = 'absolute inset-0';
            $canvasContainer.classList.remove('canvas-legendary-border', 'canvas-cosmic-border');

            if (rarity >= 10000 && rarity < 1000000) {
                flashClass = 'flash-epic';
                duration = 500;
            } else if (rarity >= 1000000 && rarity < 100000000) {
                flashClass = 'flash-legendary';
                duration = 1000;
                $canvasContainer.classList.add('canvas-legendary-border');
            } else if (rarity >= 100000000) {
                flashClass = 'flash-cosmic';
                duration = 1500;
                $canvasContainer.classList.add('canvas-cosmic-border');
            } else {
                return;
            }

            $flashOverlay.classList.add(flashClass);
            
            setTimeout(() => {
                $flashOverlay.className = 'absolute inset-0';
                $canvasContainer.classList.remove('canvas-legendary-border', 'canvas-cosmic-border');
            }, duration);
        }

        // --- éŠæˆ²æ ¸å¿ƒé‚è¼¯ ---

        function mine() {
            const maxRes = gameState.maxResources;
            const currentStone = gameState.resources.stone;
            const currentOre = gameState.resources.ore;

            if (gameState.energy <= 0 || currentStone >= maxRes || currentOre >= maxRes) return;

            // 1. æ¶ˆè€—èƒ½é‡ (pickaxeCostå¯èƒ½ç‚º0)
            gameState.energy -= gameState.pickaxeCost;
            if (gameState.energy < 0) gameState.energy = 0;

            // 2. ç”¢å‡ºåŸºç¤è³‡æº
            const baseYield = gameState.pickaxeYield;
            const depthFactor = Math.floor(gameState.depth / 10) + 1;

            let stoneGained = baseYield;
            let oreGained = 0;
            
            if (depthFactor > 1 && Math.random() < 0.2) {
                oreGained = Math.floor(Math.random() * depthFactor);
            }

            // æª¢æŸ¥ä¸¦é™åˆ¶è³‡æºåœ¨å®¹é‡å…§
            if (currentStone < maxRes) {
                gameState.resources.stone += stoneGained;
                if (gameState.resources.stone > maxRes) gameState.resources.stone = maxRes;
            } else {
                alertMessage('çŸ³é ­å®¹é‡å·²æ»¿ï¼', 'red');
            }

            if (currentOre < maxRes) {
                gameState.resources.ore += oreGained;
                if (gameState.resources.ore > maxRes) gameState.resources.ore = maxRes;
            } else {
                alertMessage('ç¤¦ç‰©å®¹é‡å·²æ»¿ï¼', 'red');
            }
            
            // æ¯æŒ– 10 æ¬¡ï¼Œæ·±åº¦+1
            if (gameState.resources.stone % 10 === 0) {
                gameState.depth += 1;
                gameState.money += depthFactor;
            }

            // --- 3. å¥‡çç¤¦çŸ³æ‰è½é‚è¼¯ (ä¿æŒä¸è®Š) ---
            let droppedRareOre = null;
            
            for (const ore of rareOresData) {
                if (Math.random() < (1 / ore.rarity)) {
                    droppedRareOre = ore;
                    break;
                }
            }

            if (droppedRareOre) {
                gameState.rareOres[droppedRareOre.id] = (gameState.rareOres[droppedRareOre.id] || 0) + 1;
                gameState.money += Math.max(1, Math.floor(Math.log10(droppedRareOre.rarity)) * 100);

                triggerRareAnimation(droppedRareOre.rarity);

                alertMessage(`æ­å–œï¼æŒ–åˆ°ç¨€æœ‰ç¤¦ç‰©: ${droppedRareOre.name}ï¼ (Rarity: 1/${droppedRareOre.rarity.toLocaleString()})`, 'yellow');
            }

            // 4. è¦–è¦ºåé¥‹
            const canvas = document.getElementById('game-canvas');
            if (!droppedRareOre || droppedRareOre.rarity < 10000) {
                canvas.style.backgroundColor = droppedRareOre ? '#8B4513' : '#333';
                setTimeout(() => {
                    canvas.style.backgroundColor = 'transparent';
                }, 50);
            } else {
                canvas.style.backgroundColor = 'transparent';
            }

            updateHUD();
        }
        
        // --- èƒ½é‡æ¢å¾©å¾ªç’° ---
        function startEnergyRegen() {
            setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy += 1;
                    if (gameState.energy > gameState.maxEnergy) {
                        gameState.energy = gameState.maxEnergy;
                    }
                    updateHUD();
                }
            }, 10000); // æ¯ 10 ç§’å›å¾© 1 é»èƒ½é‡
        }


        // --- ç¬¬äºŒæ®µä»‹é¢ (Meta Modal) é‚è¼¯ ---

        // æ¸²æŸ“å‡ç´šåˆ—è¡¨ (åŒ…å«èƒŒåŒ…æ“´å®¹)
        function renderUpgrades() {
            $upgradeList.innerHTML = '';
            upgradesData.forEach(upgrade => {
                const currentLevel = gameState[upgrade.id] || 1;
                const currentCost = upgrade.baseCost * currentLevel;
                const isMaxed = upgrade.maxLevel && currentLevel >= upgrade.maxLevel;

                let currentEffectValue = '';
                if (upgrade.id === 'maxEnergyUpgrade') currentEffectValue = gameState.maxEnergy;
                else if (upgrade.id === 'efficiency') currentEffectValue = gameState.pickaxeCost;
                else if (upgrade.id === 'yield') currentEffectValue = gameState.pickaxeYield;
                else if (upgrade.id === 'bagUpgradeLevel') currentEffectValue = gameState.maxResources;

                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div>
                        <div class="text-xl font-bold">${upgrade.name} (Lv. ${currentLevel}${isMaxed ? ' - MAX' : ''})</div>
                        <div class="text-sm">${upgrade.desc} (ç•¶å‰æ•ˆæœ: ${currentEffectValue.toLocaleString()}${upgrade.id === 'bagUpgradeLevel' ? ' å®¹é‡' : (upgrade.id === 'efficiency' ? ' èƒ½é‡æ¶ˆè€—' : '')})</div>
                        <div class="mt-1 text-secondary-color">${isMaxed ? 'å·²é”æœ€é«˜ç­‰ç´š' : `æˆæœ¬: ${currentCost.toLocaleString()} ${upgrade.costResource}`}</div>
                    </div>
                    <button data-upgrade-id="${upgrade.id}" class="pixel-btn text-base ${isMaxed ? 'bg-gray-500' : 'bg-primary-color'}" ${isMaxed ? 'disabled' : ''}>
                        ${isMaxed ? 'å·²æ»¿ç´š' : 'å‡ç´š'}
                    </button>
                `;
                $upgradeList.appendChild(card);
            });
        }
        
        // è™•ç†å‡ç´šé»æ“Šäº‹ä»¶
        function handleUpgrade(event) {
            const btn = event.target.closest('button[data-upgrade-id]');
            if (!btn) return;
            
            const id = btn.dataset.upgradeId;
            const upgrade = upgradesData.find(u => u.id === id);
            
            const currentLevel = gameState[id] || 1;
            const currentCost = upgrade.baseCost * currentLevel;

            if (gameState[upgrade.costResource] >= currentCost) {
                gameState[upgrade.costResource] -= currentCost;
                
                // åŸ·è¡Œæ•ˆæœ
                if (upgrade.effect === 'maxEnergy') {
                    gameState.maxEnergy += upgrade.value;
                    gameState.energy += upgrade.value; 
                } else if (upgrade.effect === 'pickaxeCost') {
                    gameState.pickaxeCost = Math.max(0, gameState.pickaxeCost + upgrade.value); // æ¶ˆè€—æœ€ä½ç‚º 0
                } else if (upgrade.effect === 'pickaxeYield') {
                    gameState.pickaxeYield += upgrade.value;
                } else if (upgrade.effect === 'maxResources') { // èƒŒåŒ…æ“´å®¹æ•ˆæœ
                    gameState.maxResources += upgrade.value;
                }
                
                // å‡ç´šç­‰ç´š
                gameState[id] = currentLevel + 1;

                alertMessage('å‡ç´šæˆåŠŸï¼', 'green');
                renderUpgrades();
                updateStats();
                updateHUD();

            } else {
                alertMessage(`è³‡æºä¸è¶³ï¼éœ€è¦ ${currentCost.toLocaleString()} ${upgrade.costResource}`, 'red');
            }
        }

        // æ¸²æŸ“è£½é€ åˆ—è¡¨ (é¬å­)
        function renderCrafting() {
            $craftingList.innerHTML = '';
            craftingData.forEach(item => {
                const canCraft = item.effect.level > gameState.pickaxeLevel && 
                                Object.entries(item.required).every(([res, amount]) => gameState.resources[res] >= amount || (res === 'money' && gameState.money >= amount));
                
                const isCurrent = item.effect.level === gameState.pickaxeLevel;
                const isAvailable = item.effect.level === gameState.pickaxeLevel + 1; // åªèƒ½è£½é€ ä¸‹ä¸€ç´š

                const requiredText = Object.entries(item.required).map(([res, amount]) => {
                    const resDisplay = res === 'stone' ? 'çŸ³é ­' : (res === 'ore' ? 'ç¤¦ç‰©' : 'é‡‘éŒ¢');
                    const currentRes = res === 'money' ? gameState.money : gameState.resources[res];
                    return `<span class="${currentRes < amount ? 'text-red-400' : 'text-green-400'}">${amount.toLocaleString()} ${resDisplay}</span>`;
                }).join(' / ');
                
                const disabled = isCurrent || !isAvailable || !canCraft;
                let btnText = isCurrent ? 'å·²è£å‚™' : (isAvailable ? (canCraft ? 'è£½é€ ' : 'è³‡æºä¸è¶³') : 'é–å®š');

                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div>
                        <div class="text-xl font-bold">${item.name} (Lv. ${item.effect.level})</div>
                        <div class="text-sm">${item.desc} (æ¶ˆè€—/æ”¶ç›Š: ${item.effect.cost}/${item.effect.yield})</div>
                        <div class="mt-1">éœ€æ±‚: ${requiredText}</div>
                    </div>
                    <button data-craft-id="${item.id}" class="pixel-btn text-base ${canCraft && isAvailable ? 'bg-yellow-600' : 'bg-gray-500'}" ${disabled ? 'disabled' : ''}>
                        ${btnText}
                    </button>
                `;
                $craftingList.appendChild(card);
            });
        }
        
        // è™•ç†è£½é€ é»æ“Šäº‹ä»¶
        function handleCrafting(event) {
            const btn = event.target.closest('button[data-craft-id]');
            if (!btn || btn.disabled) return;

            const id = btn.dataset.craftId;
            const item = craftingData.find(c => c.id === id);

            // æª¢æŸ¥è³‡æºæ˜¯å¦è¶³å¤  (åŒæ™‚è™•ç† money å’Œ resources)
            const canCraft = Object.entries(item.required).every(([res, amount]) => {
                const currentRes = res === 'money' ? gameState.money : gameState.resources[res];
                return currentRes >= amount;
            });

            if (canCraft) {
                // æ‰£é™¤è³‡æº
                Object.entries(item.required).forEach(([res, amount]) => {
                    if (res === 'money') {
                        gameState.money -= amount;
                    } else {
                        gameState.resources[res] -= amount;
                    }
                });

                // æ‡‰ç”¨æ•ˆæœ
                gameState.pickaxeLevel = item.effect.level;
                gameState.pickaxeCost = item.effect.cost;
                gameState.pickaxeYield = item.effect.yield;

                alertMessage(`æˆåŠŸè£½é€ ä¸¦è£å‚™ ${item.name}ï¼`, 'yellow');
                renderCrafting();
                updateStats();
                updateHUD();
            } else {
                alertMessage('è³‡æºä¸è¶³ï¼Œç„¡æ³•è£½é€ ï¼', 'red');
            }
        }
        
        // æ¸²æŸ“æ¶ˆè€—å“åˆ—è¡¨ (Shop)
        function renderConsumables() {
             $consumablesList.innerHTML = '';
             consumablesData.forEach(item => {
                const canBuy = gameState.money >= item.cost;

                const card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div>
                        <div class="text-xl font-bold">${item.name}</div>
                        <div class="text-sm">${item.desc}</div>
                        <div class="mt-1 text-secondary-color">åƒ¹æ ¼: ${item.cost.toLocaleString()} é‡‘éŒ¢</div>
                    </div>
                    <button data-item-id="${item.id}" class="pixel-btn text-base ${canBuy ? 'bg-green-600' : 'bg-gray-500'}" ${canBuy ? '' : 'disabled'}>
                        è³¼è²· & ä½¿ç”¨
                    </button>
                `;
                $consumablesList.appendChild(card);
             });
        }

        // è™•ç†æ¶ˆè€—å“è³¼è²·é»æ“Šäº‹ä»¶
        function handleConsumables(event) {
            const btn = event.target.closest('button[data-item-id]');
            if (!btn || btn.disabled) return;

            const id = btn.dataset.itemId;
            const item = consumablesData.find(c => c.id === id);

            if (gameState.money >= item.cost) {
                gameState.money -= item.cost;
                
                // æ¢å¾©èƒ½é‡
                gameState.energy += item.energy;
                
                // ç‰¹æ®Šè™•ç†è¶…ç´šèƒ½é‡é£²ï¼Œå¦‚æœèƒ½é‡è¶…ä¸Šé™ï¼Œå¯ä»¥ä¿æŒ
                if (item.energy !== 99999 && gameState.energy > gameState.maxEnergy) {
                    gameState.energy = gameState.maxEnergy;
                }

                alertMessage(`å·²è³¼è²· ${item.name}ï¼Œæ¢å¾©äº† ${item.energy.toLocaleString()} èƒ½é‡ï¼`, 'green');
                renderConsumables();
                updateHUD();
            } else {
                alertMessage('é‡‘éŒ¢ä¸è¶³ï¼Œç„¡æ³•è³¼è²·ï¼', 'red');
            }
        }
        
        // æ¸²æŸ“ç¨€æœ‰ç¤¦çŸ³åˆ—è¡¨ (ä¿æŒä¸è®Š)
        function renderRareOres() {
            $rareOreList.innerHTML = '';
            
            const collectedOres = Object.keys(gameState.rareOres)
                .filter(id => gameState.rareOres[id] > 0)
                .map(id => ({
                    ...rareOresData.find(o => o.id === id),
                    count: gameState.rareOres[id]
                }))
                .sort((a, b) => b.rarity - a.rarity);

            if (collectedOres.length === 0) {
                $rareOreList.innerHTML = '<p class="text-center col-span-full py-8 text-xl text-gray-400">å°šæœªç™¼ç¾ä»»ä½•å¥‡çç¤¦çŸ³ã€‚ç¹¼çºŒæŒ–æ˜ï¼</p>';
                return;
            }

            collectedOres.forEach(ore => {
                const card = document.createElement('div');
                card.className = 'rare-ore-card';
                card.innerHTML = `
                    <div class="text-secondary-color text-2xl mb-1">âœ¨</div>
                    <div class="font-bold text-lg">${ore.name}</div>
                    <div class="text-sm text-gray-300">æ•¸é‡: ${ore.count}</div>
                    <div class="text-xs text-green-400">æ©Ÿç‡: 1/${ore.rarity.toLocaleString()}</div>
                `;
                $rareOreList.appendChild(card);
            });
        }

        // æ›´æ–°ç‹€æ…‹é¢æ¿ (æ–°å¢å®¹é‡é¡¯ç¤º)
        function updateStats() {
            document.getElementById('stat-pickaxe').textContent = gameState.pickaxeLevel;
            document.getElementById('stat-energy-cost').textContent = gameState.pickaxeCost;
            document.getElementById('stat-base-yield').textContent = gameState.pickaxeYield;
            document.getElementById('stat-max-energy').textContent = gameState.maxEnergy;
            document.getElementById('stat-max-resources').textContent = gameState.maxResources.toLocaleString();
        }


        // ç°¡å–®çš„ UI è¨Šæ¯ï¼ˆæ›¿ä»£ alertï¼‰
        function alertMessage(msg, color) {
            const tempMsg = document.createElement('div');
            tempMsg.textContent = msg;
            tempMsg.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 pixel-btn text-white p-4 shadow-xl z-50 transition-opacity duration-300`;
            if (color === 'red') tempMsg.classList.add('bg-red-600', 'border-red-800');
            else if (color === 'green') tempMsg.classList.add('bg-green-600', 'border-green-800');
            else if (color === 'yellow') tempMsg.classList.add('bg-yellow-600', 'border-yellow-800', 'text-shadow-none');
            
            document.body.appendChild(tempMsg);
            
            setTimeout(() => {
                tempMsg.style.opacity = '0';
                setTimeout(() => tempMsg.remove(), 300);
            }, 1500);
        }

        // --- äº‹ä»¶ç›£è½å™¨è¨­å®š ---

        // Stage 1 -> Stage 2: é–‹å•Ÿå…ƒæ•¸æ“šæ¨¡å¼
        $metaBtn.addEventListener('click', () => {
            $metaModal.classList.remove('hidden');
            document.getElementById('mining-view').classList.add('hidden');
            
            // æ¯æ¬¡é–‹å•Ÿæ™‚é‡æ–°æ¸²æŸ“ Meta ä»‹é¢å…§å®¹ (ç¢ºä¿åˆå§‹é¡¯ç¤ºç¬¬ä¸€å€‹ tab çš„å…§å®¹)
            const activeTabId = document.querySelector('.meta-tab.active').dataset.tab;
            document.getElementById(activeTabId).classList.remove('hidden');
            renderUpgrades();
            renderCrafting();
            renderConsumables(); // æ¸²æŸ“æ¶ˆè€—å“
            renderRareOres();
            updateStats();
        });

        // Stage 2 -> Stage 1: é—œé–‰å…ƒæ•¸æ“šæ¨¡å¼
        $closeMetaBtn.addEventListener('click', () => {
            $metaModal.classList.add('hidden');
            document.getElementById('mining-view').classList.remove('hidden');
        });

        // æŒ–ç¤¦å‹•ä½œ
        $mineBtn.addEventListener('click', mine);
        
        // è™•ç† Meta ä»‹é¢ä¸­çš„ Tab åˆ‡æ›
        $tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const targetTab = e.target.dataset.tab;

                // ç§»é™¤æ‰€æœ‰ active ç‹€æ…‹
                $tabs.forEach(t => t.classList.remove('active'));
                $tabContents.forEach(c => c.classList.add('hidden'));

                // è¨­å®š active ç‹€æ…‹
                e.target.classList.add('active');
                document.getElementById(targetTab).classList.remove('hidden');

                // æ ¹æ“šåˆ‡æ›çš„ Tab æ¸²æŸ“å…§å®¹
                if (targetTab === 'upgrades') renderUpgrades();
                if (targetTab === 'crafting') renderCrafting();
                if (targetTab === 'consumables') renderConsumables(); // æ¸²æŸ“æ¶ˆè€—å“
                if (targetTab === 'rare_ores') renderRareOres();
                if (targetTab === 'stats') updateStats();
            });
        });

        // è™•ç† Meta ä»‹é¢ä¸­çš„å‡ç´š/è£½é€ /æ¶ˆè€—å“æŒ‰éˆ•é»æ“Š
        $upgradeList.addEventListener('click', handleUpgrade);
        $craftingList.addEventListener('click', handleCrafting);
        $consumablesList.addEventListener('click', handleConsumables); // æ¶ˆè€—å“é»æ“Šäº‹ä»¶

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            updateHUD();
            startEnergyRegen();
            try {
                console.log("éŠæˆ²åˆå§‹åŒ–å®Œæˆï¼šåƒç´ æŒ–ç¤¦ RPG å•Ÿå‹•ã€‚");
            } catch (e) {
                console.warn("ç„¡æ³•åˆå§‹åŒ– Firebaseã€‚éŠæˆ²å°‡é‹è¡Œæ–¼éæŒä¹…åŒ–æ¨¡å¼ã€‚", e);
            }
        };

        // ç¢ºä¿é»æ“ŠéæŒ‰éˆ•å€åŸŸä¹Ÿèƒ½è§¸ç™¼æŒ–ç¤¦ï¼ˆç§»å‹•ç«¯å‹å¥½ï¼‰
        document.getElementById('game-canvas').addEventListener('click', (e) => {
            const btnRect = $mineBtn.getBoundingClientRect();
            // åªæœ‰ç•¶é»æ“Šä½ç½®ä¸åœ¨æŒ‰éˆ•ä¸Šæ™‚æ‰åŸ·è¡Œ mine()
            if (e.clientX < btnRect.left || e.clientX > btnRect.right || e.clientY < btnRect.top || e.clientY > btnRect.bottom) {
                 mine();
            }
        });

    </script>
</body>
</html>